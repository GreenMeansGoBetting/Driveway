<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Driveway Stream Overlay</title>
  <style>
    html, body { margin:0; padding:0; background: transparent; }
    body { overflow:hidden; }

    #overlay {
      width: 1920px;
      height: 1080px;
      position: relative;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #fff;
    }

    #bottomBar{
      position:absolute; left:0; right:0; bottom:0;
      height:190px;
      display:flex;
      gap:18px;
      padding:18px 22px;
      box-sizing:border-box;
      background: rgba(20, 20, 22, 0.82);
      backdrop-filter: blur(6px);
    }

    #playersArea{
      flex: 1;
      display:flex;
      align-items: stretch;
      min-width:0;
    }

    .sideCol{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
    }

    .teamDivider{
      width:2px;
      margin: 0 18px;
      border-radius:2px;
      background: linear-gradient(
        to bottom,
        rgba(255,255,255,0.05),
        rgba(255,255,255,0.25),
        rgba(255,255,255,0.05)
      );
    }

    .playerCard{
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,0.08);
      box-shadow: 0 6px 16px rgba(0,0,0,0.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
    }

    .playerName{
      font-weight: 800;
      font-size: 22px;
      letter-spacing: 0.3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color:#fff;
    }

    .playerLine{
      font-size: 18px;
      color: rgba(255,255,255,0.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-variant-numeric: tabular-nums;
    }

    .sideA { text-align:left; }
    .sideB { text-align:right; }
    .sideA .playerCard { align-items:flex-start; }
    .sideB .playerCard { align-items:flex-end; }

    #scoreArea{
      width:360px;
      border-radius:16px;
      padding:12px 14px;
      box-sizing:border-box;
      background: rgba(10,10,12,0.9);
      box-shadow: 0 10px 22px rgba(0,0,0,0.25);
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:10px;
    }

    .scoreRow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
    }

    .teamLabel{
      font-weight:800;
      font-size:20px;
      opacity:0.95;
    }

    .teamScore{
      font-weight:900;
      font-size:56px;
      font-variant-numeric: tabular-nums;
      color:#fff;
    }

    .ruleLine{
      margin-top:2px;
      font-weight:800;
      font-size:15px;
      letter-spacing:0.6px;
      opacity:0.8;
      text-align:center;
    }

    #status{
      position:absolute;
      left:18px; top:18px;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(0,0,0,0.55);
      font-size:16px;
      max-width: 980px;
      line-height: 1.25;
      display:none;
      z-index: 999999;
    }
  </style>
</head>
<body>
  <div id="overlay">
    <div id="status"></div>

    <div id="bottomBar">
      <div id="playersArea">
        <div class="sideCol sideA" id="sideACol"></div>
        <div class="teamDivider"></div>
        <div class="sideCol sideB" id="sideBCol"></div>
      </div>

      <div id="scoreArea">
        <div class="scoreRow">
          <div class="teamLabel">Side A</div>
          <div class="teamScore" id="sideAScore">0</div>
        </div>
        <div class="scoreRow">
          <div class="teamLabel">Side B</div>
          <div class="teamScore" id="sideBScore">0</div>
        </div>
        <div class="ruleLine">TO 40 • WIN BY 3</div>
      </div>
    </div>
  </div>

  <!-- put your config here OR load via URL params -->
  <script>
    window.SUPABASE_URL = "https://mpvzicatxjzoaxtlieyw.supabase.co";
    window.SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY_HERE";
  </script>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const statusEl = document.getElementById("status");
    const sideACol = document.getElementById("sideACol");
    const sideBCol = document.getElementById("sideBCol");
    const sideAScoreEl = document.getElementById("sideAScore");
    const sideBScoreEl = document.getElementById("sideBScore");

    function setStatus(msg){
      statusEl.textContent = msg;
      statusEl.style.display = msg ? "block" : "none";
    }

    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    const SUPABASE_URL = window.SUPABASE_URL || getParam("supabaseUrl") || "";
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || getParam("supabaseKey") || "";

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY || String(SUPABASE_ANON_KEY).includes("PASTE_")){
      setStatus("Overlay not configured. Paste SUPABASE_URL + SUPABASE_ANON_KEY in the HTML.");
    }

    const supabase = (SUPABASE_URL && SUPABASE_ANON_KEY && !String(SUPABASE_ANON_KEY).includes("PASTE_"))
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    const STAT_TYPES = ["2PM","2PMISS","3PM","3PMISS","AST","OREB","DREB","BLK","STL"];

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function compute(game, events){
      const lines = new Map();
      const allPids = [...(game.sidea_player_ids||[]), ...(game.sideb_player_ids||[])];

      for (const pid of allPids){
        const o = {};
        for (const s of STAT_TYPES) o[s]=0;
        lines.set(pid, o);
      }

      for (const ev of events){
        const line = lines.get(ev.player_id);
        if (!line) continue;
        line[ev.stat_type] = (line[ev.stat_type]||0) + (ev.delta||1);
      }

      const derived = (pid)=>{
        const l = lines.get(pid) || {};
        const twoA = (l["2PM"]||0) + (l["2PMISS"]||0);
        const threeA = (l["3PM"]||0) + (l["3PMISS"]||0);
        const pts = (l["2PM"]||0)*2 + (l["3PM"]||0)*3;
        const reb = (l["OREB"]||0) + (l["DREB"]||0);
        return { twoA, threeA, pts, reb };
      };

      const scoreA = (game.sidea_player_ids||[]).reduce((s,p)=>s+derived(p).pts,0);
      const scoreB = (game.sideb_player_ids||[]).reduce((s,p)=>s+derived(p).pts,0);

      return { lines, derived, scoreA, scoreB };
    }

    function statLine(pid, box){
      const l = box.lines.get(pid) || {};
      const d = box.derived(pid);
      return `PTS ${d.pts} | 2s ${(l["2PM"]||0)}-${d.twoA} | 3s ${(l["3PM"]||0)}-${d.threeA} | REB ${d.reb} (O${(l["OREB"]||0)}/D${(l["DREB"]||0)}) | AST ${(l["AST"]||0)} | STL ${(l["STL"]||0)} | BLK ${(l["BLK"]||0)}`;
    }

    function playerCard(name, line){
      return `
        <div class="playerCard">
          <div class="playerName">${escapeHtml(name)}</div>
          <div class="playerLine">${escapeHtml(line)}</div>
        </div>
      `;
    }

    async function getActiveGameId(){
      // Try stream_state first
      try{
        const { data, error } = await supabase
          .from("stream_state")
          .select("active_game_id")
          .eq("id","main")
          .single();

        if (!error && data && data.active_game_id) return data.active_game_id;
      } catch(e){}

      // Fallback: most recent non-finalized game
      const { data: games, error: gerr } = await supabase
        .from("games")
        .select("game_id, played_at, finalized")
        .eq("finalized", false)
        .order("played_at", { ascending:false })
        .limit(1);

      if (gerr){
        console.error(gerr);
        return null;
      }
      return games && games.length ? games[0].game_id : null;
    }

    async function loadAndRender(gameId){
      // game
      const { data: game, error: gameErr } = await supabase
        .from("games")
        .select("*")
        .eq("game_id", gameId)
        .single();

      if (gameErr || !game){
        setStatus("Could not load game from Supabase. (Check RLS on games)");
        console.error(gameErr);
        return;
      }

      // events
      const { data: events, error: evErr } = await supabase
        .from("events")
        .select("*")
        .eq("game_id", gameId);

      if (evErr){
        setStatus("Could not load events from Supabase. (Check RLS on events)");
        console.error(evErr);
        return;
      }

      // players for names
      const allPids = [...(game.sidea_player_ids||[]), ...(game.sideb_player_ids||[])];
      const { data: players, error: pErr } = await supabase
        .from("players")
        .select("player_id, name")
        .in("player_id", allPids);

      if (pErr){
        setStatus("Could not load players from Supabase. (Check RLS on players)");
        console.error(pErr);
        return;
      }

      const nameById = new Map((players||[]).map(p=>[p.player_id, p.name]));

      const box = compute(game, events||[]);
      sideAScoreEl.textContent = box.scoreA;
      sideBScoreEl.textContent = box.scoreB;

      const sideAHTML = (game.sidea_player_ids||[]).map(pid=>{
        return playerCard(nameById.get(pid) || "—", statLine(pid, box));
      }).join("");

      const sideBHTML = (game.sideb_player_ids||[]).map(pid=>{
        return playerCard(nameById.get(pid) || "—", statLine(pid, box));
      }).join("");

      sideACol.innerHTML = sideAHTML;
      sideBCol.innerHTML = sideBHTML;

      setStatus(""); // clear any old warnings once rendering works
    }

    (async function boot(){
      if (!supabase) return;

      let currentGameId = null;

      // Poll loop (no realtime needed)
      setInterval(async ()=>{
        const gid = await getActiveGameId();
        if (!gid){
          setStatus("No active game found. Start a game, then sync once (or disable RLS for overlay reads).");
          return;
        }
        currentGameId = gid;
        await loadAndRender(currentGameId);
      }, 500);
    })();
  </script>
</body>
</html>
