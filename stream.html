<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Driveway Stream Overlay</title>
  <style>
    html, body { margin:0; padding:0; background: transparent; }
    body { overflow:hidden; }

    #overlay {
      width: 1920px;
      height: 1080px;
      position: relative;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #fff;
    }

    #bottomBar{
      position:absolute; left:0; right:0; bottom:0;
      height:190px;
      display:flex;
      gap:18px;
      padding:18px 22px;
      box-sizing:border-box;
      background: rgba(20, 20, 22, 0.82);
      backdrop-filter: blur(6px);
    }

    #playersArea{
      flex: 1;
      display:flex;
      align-items: stretch;
      min-width:0;
    }

    .sideCol{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
    }

    .teamDivider{
      width:2px;
      margin: 0 18px;
      border-radius:2px;
      background: linear-gradient(
        to bottom,
        rgba(255,255,255,0.05),
        rgba(255,255,255,0.25),
        rgba(255,255,255,0.05)
      );
    }

    .playerCard{
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,0.08);
      box-shadow: 0 6px 16px rgba(0,0,0,0.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
    }

    .playerName{
      font-weight: 800;
      font-size: 22px;
      letter-spacing: 0.3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color:#fff;
    }

    .playerLine{
      font-size: 18px;
      color: rgba(255,255,255,0.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-variant-numeric: tabular-nums;
    }

    .sideA { text-align:left; }
    .sideB { text-align:right; }
    .sideA .playerCard { align-items:flex-start; }
    .sideB .playerCard { align-items:flex-end; }

    #scoreArea{
      width:360px;
      border-radius:16px;
      padding:12px 14px;
      box-sizing:border-box;
      background: rgba(10,10,12,0.9);
      box-shadow: 0 10px 22px rgba(0,0,0,0.25);
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:10px;
    }

    .scoreRow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
    }

    .teamLabel{
      font-weight:800;
      font-size:20px;
      opacity:0.95;
    }

    .teamScore{
      font-weight:900;
      font-size:56px;
      font-variant-numeric: tabular-nums;
      color:#fff;
    }

    .ruleLine{
      margin-top:2px;
      font-weight:800;
      font-size:15px;
      letter-spacing:0.6px;
      opacity:0.8;
      text-align:center;
    }

    .flash{
      animation: pulseHighlight 0.9s ease-out 1;
    }
    @keyframes pulseHighlight{
      0%   { background: rgba(255,255,255,0.18); transform: translateY(-1px); }
      40%  { background: rgba(255,255,255,0.12); box-shadow: 0 0 24px rgba(255,255,255,0.18); }
      100% { background: rgba(255,255,255,0.08); transform: translateY(0px); }
    }

    #status{
      position:absolute;
      left:18px; top:18px;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(0,0,0,0.55);
      font-size:16px;
      max-width: 820px;
      line-height: 1.25;
      display:none;
      z-index:9999;
    }
  </style>
</head>
<body>
  <div id="overlay">
    <div id="status"></div>

    <div id="bottomBar">
      <div id="playersArea">
        <div class="sideCol sideA" id="sideACol"></div>
        <div class="teamDivider"></div>
        <div class="sideCol sideB" id="sideBCol"></div>
      </div>

      <div id="scoreArea">
        <div class="scoreRow">
          <div class="teamLabel">Side A</div>
          <div class="teamScore" id="sideAScore">0</div>
        </div>
        <div class="scoreRow">
          <div class="teamLabel">Side B</div>
          <div class="teamScore" id="sideBScore">0</div>
        </div>
        <div class="ruleLine">TO 40 • WIN BY 3</div>
      </div>
    </div>
  </div>

  <!-- Put your Supabase URL/key here OR load via ?supabaseUrl=...&supabaseKey=... -->
  <script>
    window.SUPABASE_URL = "https://mpvzicatxjzoaxtlieyw.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wdnppY2F0eGp6b2F4dGxpZXl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMzEyOTcsImV4cCI6MjA4NzcwNzI5N30.QmpgY48F1_5OBeW0J8HQ_TDWfFy_rds-vnlDRtpFEqk"; // <-- keep your existing key
  </script>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    /********************
     * CONFIG (matches YOUR schema)
     ********************/
    const CONFIG = {
      STREAM_STATE_TABLE: "stream_state",
      STREAM_STATE_PK_COL: "id",
      STREAM_STATE_PK_VAL: "main",
      STREAM_STATE_ACTIVE_GAME_COL: "active_game_id",

      GAMES_TABLE: "games",
      GAME_ID_COL: "game_id",
      GAME_SIDEA_IDS_COL: "sidea_player_ids",
      GAME_SIDEB_IDS_COL: "sideb_player_ids",

      PLAYERS_TABLE: "players",
      PLAYER_ID_COL: "player_id",
      PLAYER_NAME_COL: "name",

      EVENTS_TABLE: "events",
      EVENTS_GAME_ID_COL: "game_id",
      EVENTS_PLAYER_ID_COL: "player_id",
      EVENTS_STAT_COL: "stat_type",
      EVENTS_DELTA_COL: "delta",
      EVENTS_TIME_COL: "timestamp"
    };

    /********************
     * DOM
     ********************/
    const statusEl = document.getElementById("status");
    const sideACol = document.getElementById("sideACol");
    const sideBCol = document.getElementById("sideBCol");
    const sideAScoreEl = document.getElementById("sideAScore");
    const sideBScoreEl = document.getElementById("sideBScore");

    function setStatus(msg){
      statusEl.textContent = msg || "";
      statusEl.style.display = msg ? "block" : "none";
    }

    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    const SUPABASE_URL = window.SUPABASE_URL || getParam("supabaseUrl") || "";
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || getParam("supabaseKey") || "";

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY){
      setStatus("Overlay not configured. Set window.SUPABASE_URL and window.SUPABASE_ANON_KEY.");
    }

    const supabase = (SUPABASE_URL && SUPABASE_ANON_KEY)
      ? window.sbClient.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    /********************
     * STAT COMPUTE (same logic as your app)
     ********************/
    const STAT_TYPES = ["2PM","2PMISS","3PM","3PMISS","AST","OREB","DREB","BLK","STL"];

    function computeFromEvents(sideAIds, sideBIds, events){
      const lines = new Map();
      const all = [...sideAIds, ...sideBIds];
      for (const pid of all){
        const o = {};
        for (const s of STAT_TYPES) o[s] = 0;
        lines.set(pid, o);
      }

      for (const ev of events){
        const pid = ev[CONFIG.EVENTS_PLAYER_ID_COL];
        const stat = ev[CONFIG.EVENTS_STAT_COL];
        const delta = ev[CONFIG.EVENTS_DELTA_COL] ?? 1;
        const line = lines.get(pid);
        if (!line) continue;
        line[stat] = (line[stat] || 0) + delta;
      }

      const derived = (pid)=>{
        const l = lines.get(pid) || {};
        const twoA = (l["2PM"]||0) + (l["2PMISS"]||0);
        const threeA = (l["3PM"]||0) + (l["3PMISS"]||0);
        const pts = (l["2PM"]||0)*2 + (l["3PM"]||0)*3;
        const reb = (l["OREB"]||0) + (l["DREB"]||0);
        return { twoA, threeA, pts, reb };
      };

      const scoreA = sideAIds.reduce((s,p)=> s + derived(p).pts, 0);
      const scoreB = sideBIds.reduce((s,p)=> s + derived(p).pts, 0);

      return { lines, derived, scoreA, scoreB };
    }

    function statLineFor(pid, box){
      const line = box.lines.get(pid) || {};
      const d = box.derived(pid);
      return `PTS ${d.pts} | 2s ${(line["2PM"]||0)}-${d.twoA} | 3s ${(line["3PM"]||0)}-${d.threeA} | REB ${d.reb} (O${(line["OREB"]||0)}/D${(line["DREB"]||0)}) | AST ${(line["AST"]||0)} | STL ${(line["STL"]||0)} | BLK ${(line["BLK"]||0)}`;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function cardHTML(pid, name, line){
      return `
        <div class="playerCard" id="player-${pid}">
          <div class="playerName">${escapeHtml(name)}</div>
          <div class="playerLine">${escapeHtml(line)}</div>
        </div>
      `;
    }

    function flashPlayer(pid){
      const el = document.getElementById(`player-${pid}`);
      if (!el) return;
      el.classList.remove("flash");
      void el.offsetWidth;
      el.classList.add("flash");
    }

    let lastLineByPid = new Map();

    function renderScreen(sideAIds, sideBIds, namesById, box){
      sideAScoreEl.textContent = String(box.scoreA ?? 0);
      sideBScoreEl.textContent = String(box.scoreB ?? 0);

      const sideAHtml = sideAIds.map(pid => cardHTML(pid, namesById.get(pid) || "—", statLineFor(pid, box))).join("");
      const sideBHtml = sideBIds.map(pid => cardHTML(pid, namesById.get(pid) || "—", statLineFor(pid, box))).join("");

      sideACol.innerHTML = sideAHtml;
      sideBCol.innerHTML = sideBHtml;

      // flash on change
      for (const pid of [...sideAIds, ...sideBIds]){
        const line = statLineFor(pid, box);
        const old = lastLineByPid.get(pid);
        if (old !== undefined && old !== line) flashPlayer(pid);
        lastLineByPid.set(pid, line);
      }
    }

    /********************
     * LOADERS (POLLING ONLY - no realtime websockets)
     ********************/
    let activeGameId = null;

    async function loadActiveGameId(){
      const { data, error } = await supabase
        .from(CONFIG.STREAM_STATE_TABLE)
        .select(CONFIG.STREAM_STATE_ACTIVE_GAME_COL)
        .eq(CONFIG.STREAM_STATE_PK_COL, CONFIG.STREAM_STATE_PK_VAL)
        .single();

      if (error){
        console.error(error);
        setStatus("Could not read stream_state (check RLS/policies).");
        return null;
      }
      return data?.[CONFIG.STREAM_STATE_ACTIVE_GAME_COL] ?? null;
    }

    async function loadGame(gameId){
      const { data: game, error: gameErr } = await supabase
        .from(CONFIG.GAMES_TABLE)
        .select("*")
        .eq(CONFIG.GAME_ID_COL, gameId)
        .single();

      if (gameErr){
        console.error(gameErr);
        setStatus("Could not load game row (check RLS/policies).");
        return null;
      }
      return game;
    }

    async function loadPlayersByIds(ids){
      if (!ids.length) return new Map();
      const { data, error } = await supabase
        .from(CONFIG.PLAYERS_TABLE)
        .select(`${CONFIG.PLAYER_ID_COL},${CONFIG.PLAYER_NAME_COL}`)
        .in(CONFIG.PLAYER_ID_COL, ids);

      if (error){
        console.error(error);
        setStatus("Could not load players (check RLS/policies).");
        return new Map();
      }
      const m = new Map();
      for (const p of (data||[])){
        m.set(p[CONFIG.PLAYER_ID_COL], p[CONFIG.PLAYER_NAME_COL]);
      }
      return m;
    }

    async function loadEventsForGame(gameId){
      const { data, error } = await supabase
        .from(CONFIG.EVENTS_TABLE)
        .select("*")
        .eq(CONFIG.EVENTS_GAME_ID_COL, gameId)
        .order(CONFIG.EVENTS_TIME_COL, { ascending: true });

      if (error){
        console.error(error);
        setStatus("Could not load events (check RLS/policies).");
        return [];
      }
      return data || [];
    }

    async function refresh(){
      const gid = await loadActiveGameId();

      if (!gid){
        activeGameId = null;
        lastLineByPid = new Map();
        setStatus("No active game set (stream_state.active_game_id is null). Start a game in the app.");
        sideAScoreEl.textContent = "0";
        sideBScoreEl.textContent = "0";
        sideACol.innerHTML = "";
        sideBCol.innerHTML = "";
        return;
      }

      setStatus("");

      // if game changed, reset flash baseline
      if (gid !== activeGameId){
        activeGameId = gid;
        lastLineByPid = new Map();
      }

      const game = await loadGame(activeGameId);
      if (!game) return;

      const sideAIds = game[CONFIG.GAME_SIDEA_IDS_COL] || [];
      const sideBIds = game[CONFIG.GAME_SIDEB_IDS_COL] || [];
      const allIds = [...sideAIds, ...sideBIds];

      const [namesById, events] = await Promise.all([
        loadPlayersByIds(allIds),
        loadEventsForGame(activeGameId)
      ]);

      const box = computeFromEvents(sideAIds, sideBIds, events);
      renderScreen(sideAIds, sideBIds, namesById, box);
    }

    (async function boot(){
      if (!supabase) return;
      await refresh();
      // Poll fast enough for “live” feel without websockets
      setInterval(refresh, 350);
    })();
  </script>
</body>
</html>
